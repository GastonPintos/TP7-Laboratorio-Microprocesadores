.device ATmega328P
.cseg
.org 0x0000

.EQU PIN_BTN1=2
.EQU PIN_BTN2=3
.EQU PIN_LED=6

.EQU PASO = 10

.DEF TEMP = R16
.DEF COUNTER = R17

main:
	
	LDI R16,HIGH(RAMEND)
	STS SPH,R16
	LDI R16, LOW(RAMEND)
	STS SPL, R16
	
	/*Configuracion de puertos*/
    CBI DDRD, PIN_BTN1
	CBI DDRD, PIN_BTN2
	SBI DDRD, PIN_LED

	/*Configuro el timer0*/
	LDI R16,(1<<WGM01)|(1<<WGM00)|(1<<COM0A1) ;Non-inverted COM0A && WGM2:0=011= Mode 3 
	OUT TCCR0A,R16
	LDI R17,(1<<CS00);	;Fast PWM, modo 3. No prescaling
	OUT TCCR0B,R17

	/*Leo el valor de OCR0A*/
	IN COUNTER, OCR0A
	LDI TEMP, PASO

LOOP:
    SBIC PIND, PIN_BTN1
    RJMP INC_COUNTER
	SBIC PIND, PIN_BTN2
	RJMP DEC_COUNTER
	RJMP LOOP
	
INC_COUNTER:
	CALL ANTIBOUNCE_BTN1
	ADD COUNTER,TEMP				
	OUT OCR0A, COUNTER			
	RJMP LOOP			

DEC_COUNTER:
	CALL ANTIBOUNCE_BTN2
	SUB COUNTER, TEMP				
	OUT OCR0A, COUNTER		
	RJMP LOOP

RESET_COUNTER:
	LDI COUNTER, 0x00
	CALL DELAY
	RJMP LOOP

ANTIBOUNCE_BTN1:
	CALL DELAY
	SBIS PIND, PIN_BTN1	
	RJMP LOOP			
	RET

ANTIBOUNCE_BTN2:
	CALL DELAY
	SBIS PIND, PIN_BTN2	
	RJMP LOOP			
	RET

DELAY:
; Delay 600 000 cycles
; 37.5ms at 16.0 MHz
    LDI  R20, 60
L1: LDI  R21, 40
L2:	LDI  R22, 250
L3:	DEC  R22
    BRNE L3		; Repetir 250 veces
    DEC  R21
    BRNE L2		; Repetir L3 unas 40 veces	(Ciclos = 250*40 = 10 000)
	DEC  R20
	BRNE L1		; Repetir L2 unas 80 veces	(Ciclos = 10 000*60 = 600 000)
	RET
